---
title: TCP拥塞控制
tags:
  - TCP/IP
categories:
  - TCP/IP
date: 2020-04-26 18:56:29
---

这篇文章记述了关于TCP拥塞控制的知识点。

<!--more-->

## 流量控制

流量控制是一个端到端的问题。

## 拥塞控制

拥塞控制是一个全局性的过程。涉及到所有的主机、路由器等。拥塞控制和流量控制之所以常常被弄混，是因为某些拥塞控制算法是向发送端发送控制报文，并告诉发送端，网络已出现麻烦，必须放慢发送速率。这点又和流量控制是很相似的。

TCP进行拥塞控制的四种算法：慢开始，拥塞避免，快重传和快恢复。

下面讨论的拥塞控制基于窗口。为此，发送方维持一个叫做拥塞窗口的状态变量。拥塞窗口的大小取决于网络的拥塞程度，并且动态的在变化。发送方让自己的发送窗口等于拥塞窗口。

发送方控制拥塞窗口的原则是：只要网络没有出现拥塞，拥塞窗口就可以再增大一点，以便把更多的分组发送出去，这样可以提高网络的利用率。但是只要网络中出现拥塞，就必须把拥塞窗口减小一点，以减少注入到网络中的分组数，以便缓解网络出现的阻塞。

### 慢开始

服务器发送数据包，当然越快越好，最好一次性全发出去。但是，发得太快，就有可能丢包。带宽小、路由器过热、缓存溢出等许多因素都会导致丢包。线路不好的话，发得越快，丢得越多。

最理想的状态是，在线路允许的情况下，达到最高速率。但是我们怎么知道，对方线路的理想速率是多少呢？答案就是慢慢试。

TCP 协议为了做到效率与可靠性的统一，设计了一个慢启动（slow start）机制。开始的时候，发送得较慢，然后根据丢包的情况，调整速率：如果不丢包，就加快发送速度；如果丢包，就降低发送速度。

Linux 内核里面[设定](http://elixir.free-electrons.com/linux/v4.5/source/include/net/tcp.h#L220)了（常量`TCP_INIT_CWND`），刚开始通信的时候，发送方一次性发送10个数据包，即"发送窗口"的大小为10。然后停下来，等待接收方的确认，再继续发送。

默认情况下，接收方每收到[两个](https://serverfault.com/questions/348666/when-the-tcp-engine-decides-to-send-an-ack) TCP 数据包，就要[发送](https://stackoverflow.com/a/3604882/1194049)一个确认消息。"确认"的英语是 acknowledgement，所以这个确认消息就简称 ACK。

ACK 携带两个信息。

> - 期待要收到下一个数据包的编号
> - 接收方的接收窗口的剩余容量

发送方有了这两个信息，再加上自己已经发出的数据包的最新编号，就会推测出接收方大概的接收速度，从而降低或增加发送速率。这被称为"发送窗口"，这个窗口的大小是可变的。

快送重传就是基于以下机制：如果假设重复阈值为3，当发送方收到4次相同确认号的分段确认（第1次收到确认期望序列号，加3次重复的期望序列号确认）时，则可以认为继续发送更高序列号的分段将会被接受方丢弃，而且会无法有序送达。发送方应该忽略超时计时器的等待重发，立即重发重复分段确认中确认号对应序列号的分段。

![image-20200415213302421](https://i.loli.net/2020/04/15/mGzK1xJvgqbfURn.png)

### 快重传

快重传算法首先要求接收方每收到一个失序的报文段就立即发出重复确认（为的是使发送方及早的知道有报文段没有到达对方）而不要等到自己发送数据时才捎带确认。

快重传算法规定，发送方只要一连收到三个重复确认就应当立即重传对方尚未收到的报文段，而不必继续等待为其设置的重传计时器到期。快重传配合使用的还有快恢复算法，有以下两个要点:

①当发送方连续收到三个重复确认时，就执行“乘法减小”算法，把ssthresh门限减半。但是接下去并不执行慢开始算法。